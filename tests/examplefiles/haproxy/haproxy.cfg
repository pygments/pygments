# This configuration creates a classical reverse-proxy and load balancer for
# public services. It presents ports 80 and 443 (with 80 redirecting to 443),
# enables caching up to one hour, and load-balances the service on a farm of
# 4 servers on private IP addresses which are checked using HTTP checks and
# by maintaining stickiness via session cookies. It offloads TLS processing
# and enables HTTP compression. It uses HAProxy 2.4.

# The global section deals with process-wide settings (security, resource usage)
global
	default-path config
	zero-warning
	chroot /var/empty
	user haproxy
	group haproxy
	daemon
	pidfile /var/run/haproxy-svc1.pid
	hard-stop-after 5m
	stats socket /var/run/haproxy-svc1.sock level admin mode 600 user haproxy expose-fd listeners
	stats timeout 1h
	log stderr local0 info
	ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
	ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384
	ssl-default-bind-options prefer-client-ciphers no-sslv3 no-tlsv10 no-tlsv11
	maxconn 10000
	uid 200
	gid 200
	tune.bufsize 16384
	tune.ssl.default-dh-param 2048

defaults http
	mode http
	option httplog
	log global
	timeout client 1m
	timeout server 1m
	timeout connect 10s
	timeout http-keep-alive 2m
	timeout queue 15s
	timeout tunnel 4h

frontend stats
	bind :8181
	stats uri /
	stats show-modules

.if feature(QUIC)
frontend pub1
	bind :80 name clear
	bind :443 name secure ssl crt pub1.pem
	bind quic4@:443 name quic ssl crt pub1.pem allow-0rtt
	http-response add-header alt-svc 'h3=":443"; ma=90000'
.else
frontend pub1
	bind :80 name clear
	bind :443 name secure ssl crt pub1.pem
.endif

	http-after-response set-header Strict-Transport-Security "max-age=31536000"
	http-request redirect scheme https code 301 if !{ ssl_fc }
	option http-ignore-probes
	http-request del-header x-forwarded-for
	option forwardfor
	compression algo deflate gzip
	compression type text/ application/javascript application/xhtml+xml image/x-icon
	http-request cache-use cache
	http-response cache-store cache
	default_backend app1
	acl is_static path_beg /static /images
	acl host_match hdr(host) -i www.example.com
	use_backend static if is_static
	use_backend app1 if { hdr_beg(host) -i api }
	use_backend app1 if { path_beg /api } || { path_beg /v2 }

cache cache
	total-max-size 200
	max-object-size 10485760
	max-age 3600
	process-vary on

backend app1
	balance random
	option abortonclose
	cookie app1 insert indirect nocache
	option httpchk
	http-check send meth GET uri / ver HTTP/1.1 hdr host svc1.example.com
	server srv1 192.0.2.1:80 cookie s1 maxconn 100 check inter 1s
	server srv2 192.0.2.2:80 cookie s2 maxconn 100 check inter 1s
	server srv3 192.0.2.3:80 cookie s3 maxconn 100 check inter 1s
	server srv4 192.0.2.4:80 cookie s4 maxconn 100 check inter 1s

backend static
	mode http
	balance roundrobin
	option prefer-last-server
	retries 2
	option redispatch
	timeout connect 5s
	timeout server 5s
	option httpchk HEAD /favicon.ico
	server statsrv1 192.168.1.8:80 check inter 1000
	server statsrv2 192.168.1.9:80 check inter 1000

listen health-check
	bind :9000
	mode http
	monitor-uri /health
	option httplog
	server local 127.0.0.1:8080 check

resolvers mydns
	nameserver dns1 10.0.0.1:53
	nameserver dns2 10.0.0.2:53
	resolve_retries 3
	timeout resolve 1s
	timeout retry 1s
	hold valid 10s

peers mypeers
	peer haproxy1 192.168.1.1:1024
	peer haproxy2 192.168.1.2:1024

userlist myusers
	group admins users admin
	user admin insecure-password changeme
	user guest insecure-password guest

.notice 'Configuration loaded successfully'

# Environment variable usage
# bind :${HAPROXY_PORT}
# server app1 ${APP_HOST}:${APP_PORT} check
